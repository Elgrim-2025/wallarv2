<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>벽면 페인팅 AR</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{
            --bg:#000;--sf:#111;--bd:#222;
            --tx:#fff;--txd:#888;--ac:#4488ff;
        }
        html,body{width:100%;height:100%;overflow:hidden;font-family:'Pretendard',sans-serif;background:#000;color:var(--tx);touch-action:none}

        /* ── Loading Overlay ── */
        .ov{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:300;transition:opacity .5s}
        .ov.gone{opacity:0;pointer-events:none}
        .ov .spinner{width:36px;height:36px;border:3px solid #333;border-top-color:#fff;border-radius:50%;animation:sp .7s linear infinite}
        @keyframes sp{to{transform:rotate(360deg)}}
        .ov p{margin-top:16px;font-size:13px;color:#aaa;font-weight:400}

        /* ── Main Layout ── */
        .app{width:100%;height:100%;display:flex;flex-direction:column;position:relative}

        /* ── Camera / Canvas Area ── */
        .camera-area{flex:1;position:relative;background:#000;overflow:hidden}
        .camera-area video,.camera-area canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
        #vid{z-index:1}
        #cvResult{z-index:2}
        .camera-area .placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:5;gap:12px}
        .camera-area .placeholder svg{width:48px;height:48px;opacity:.3}
        .camera-area .placeholder p{font-size:13px;color:#666;font-weight:400}

        /* Seed indicator */
        .seed-indicator{position:absolute;z-index:10;width:24px;height:24px;border:2.5px solid #fff;border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;box-shadow:0 0 0 1px rgba(0,0,0,.4),0 2px 8px rgba(0,0,0,.5);display:none}
        .seed-indicator::after{content:'';position:absolute;inset:4px;border:1px solid rgba(255,255,255,.5);border-radius:50%}

        /* Top status bar */
        .top-bar{position:absolute;top:0;left:0;right:0;z-index:20;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,rgba(0,0,0,.6) 0%,transparent 100%)}
        .top-bar .title{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;letter-spacing:.5px;color:rgba(255,255,255,.8)}
        .top-bar .fps-badge{font-family:'JetBrains Mono',monospace;font-size:10px;color:rgba(255,255,255,.5);background:rgba(0,0,0,.4);padding:3px 8px;border-radius:10px}
        .top-bar .fill-info{font-family:'JetBrains Mono',monospace;font-size:10px;color:rgba(255,255,255,.6)}

        /* ── Bottom Panel ── */
        .bottom-panel{background:#111;border-top:1px solid #222;flex-shrink:0;display:flex;flex-direction:column;position:relative;z-index:50}

        /* Color category tabs */
        .cat-tabs{display:flex;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid #222;padding:0 8px}
        .cat-tabs::-webkit-scrollbar{display:none}
        .cat-tab{flex-shrink:0;padding:10px 14px;font-size:11px;font-weight:500;color:#666;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap}
        .cat-tab.active{color:#fff;border-bottom-color:#fff}
        .cat-tab:hover{color:#aaa}

        /* Color swatches row */
        .color-row{display:flex;overflow-x:auto;scrollbar-width:none;padding:12px 12px 6px;gap:8px;align-items:flex-start}
        .color-row::-webkit-scrollbar{display:none}
        .swatch{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;transition:transform .15s}
        .swatch:active{transform:scale(.92)}
        .swatch .chip{width:44px;height:44px;border-radius:10px;border:2px solid transparent;transition:border-color .2s,box-shadow .2s;position:relative}
        .swatch.active .chip{border-color:#fff;box-shadow:0 0 0 2px rgba(255,255,255,.3)}
        .swatch .chip::after{content:'';position:absolute;inset:0;border-radius:8px;border:1px solid rgba(255,255,255,.08)}
        .swatch .name{font-size:8px;color:#777;font-weight:400;text-align:center;max-width:48px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;line-height:1.2}
        .swatch .code{font-family:'JetBrains Mono',monospace;font-size:7px;color:#555}

        /* Alpha slider */
        .alpha-row{display:flex;align-items:center;gap:10px;padding:6px 16px 8px}
        .alpha-row label{font-size:10px;color:#666;font-weight:500;flex-shrink:0}
        .alpha-row input[type=range]{flex:1;-webkit-appearance:none;height:3px;background:#333;border-radius:2px;outline:none}
        .alpha-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#fff;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.4)}
        .alpha-row .val{font-family:'JetBrains Mono',monospace;font-size:10px;color:#aaa;width:28px;text-align:right}

        /* Bottom action bar */
        .action-bar{display:flex;align-items:center;justify-content:center;padding:8px 16px 20px;gap:16px}
        .action-bar .cam-btn{width:56px;height:56px;border-radius:50%;border:3px solid #fff;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;position:relative}
        .action-bar .cam-btn.recording{border-color:#ff4444;background:rgba(255,68,68,.15)}
        .action-bar .cam-btn .inner{width:20px;height:20px;border-radius:50%;background:#fff;transition:all .2s}
        .action-bar .cam-btn.recording .inner{width:18px;height:18px;border-radius:4px;background:#ff4444}
        .action-bar .side-btn{width:40px;height:40px;border-radius:50%;border:1px solid #333;background:#1a1a1a;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#888;transition:all .2s}
        .action-bar .side-btn:hover{background:#222;color:#fff}
        .action-bar .side-btn svg{width:18px;height:18px}

        /* Hidden canvases */
        #cvEdge,#cvMask{display:none}

        /* Color detail tooltip */
        .color-tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#222;border:1px solid #333;border-radius:8px;padding:8px 12px;pointer-events:none;opacity:0;transition:opacity .2s;z-index:60;white-space:nowrap;margin-bottom:8px}
        .color-tooltip.show{opacity:1}
        .color-tooltip .ct-name{font-size:11px;font-weight:600;color:#fff;margin-bottom:2px}
        .color-tooltip .ct-code{font-family:'JetBrains Mono',monospace;font-size:9px;color:#888}
        .color-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#222}

        /* Landscape */
        @media(orientation:landscape) and (max-height:500px){
            .app{flex-direction:row}
            .bottom-panel{width:280px;border-top:none;border-left:1px solid #222;overflow-y:auto}
            .cat-tabs{flex-wrap:wrap}
        }

        /* Desktop */
        @media(min-width:768px){
            .swatch .chip{width:52px;height:52px}
            .swatch .name{font-size:9px;max-width:56px}
        }
    </style>
</head>
<body>

<div class="ov" id="ov"><div class="spinner"></div><p>OpenCV.js 로딩 중…</p></div>

<div class="app">
    <div class="camera-area" id="cameraArea">
        <div class="top-bar">
            <span class="title">WALL PAINT AR</span>
            <span class="fill-info" id="fillInfo"></span>
            <span class="fps-badge" id="fpsEl">-- fps</span>
        </div>
        <video id="vid" autoplay playsinline muted></video>
        <canvas id="cvResult"></canvas>
        <canvas id="cvEdge"></canvas>
        <canvas id="cvMask"></canvas>
        <div class="seed-indicator" id="seedDot"></div>
        <div class="placeholder" id="ph">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" color="#555">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
            <p>터치하여 카메라 시작</p>
        </div>
    </div>

    <div class="bottom-panel" id="bottomPanel">
        <div class="cat-tabs" id="catTabs"></div>
        <div class="color-row" id="colorRow"></div>
        <!-- 투명도 0.7 고정 -->
        <div class="action-bar">
            <button class="side-btn" onclick="resetSeed()" title="초기화">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
            </button>
            <button class="cam-btn" id="camBtn" onclick="toggleCam()">
                <div class="inner"></div>
            </button>
            <button class="side-btn" onclick="captureFrame()" title="캡처">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </div>
    </div>
</div>

<script>
    /* ═══════════════════════════════════════
       JEVISCO 베스트 컬러 컬렉션 기반 색상 팔레트
       카테고리: White, Tint, Tone, Gray, Color, Shade, Black
       색상계열: Red, YellowRed, Yellow, GreenYellow, Green, BlueGreen, Blue, PurpleBlue, Purple, RedPurple, Neutral
       ═══════════════════════════════════════ */
    const JEVISCO_COLORS = {
        "화이트 White": [
            {name:"스노우 화이트",code:"JC-0001",hex:"#FAFAFA"},
            {name:"밀크 화이트",code:"JC-0002",hex:"#F5F0E8"},
            {name:"아이보리 화이트",code:"JC-0003",hex:"#F2EDE0"},
            {name:"크림 화이트",code:"JC-0004",hex:"#F8F1E4"},
            {name:"라이트 린넨",code:"JC-0005",hex:"#F0EBE0"},
            {name:"펄 화이트",code:"JC-0006",hex:"#F0EEE9"},
            {name:"소프트 화이트",code:"JC-0007",hex:"#EDEBE6"},
            {name:"문라이트",code:"JC-0008",hex:"#F5F3ED"},
            {name:"코튼 화이트",code:"JC-0009",hex:"#EDE8DC"},
            {name:"클라우드 화이트",code:"JC-0010",hex:"#E8E4DB"},
            {name:"실크 화이트",code:"JC-0011",hex:"#E5DFD3"},
            {name:"페이퍼 화이트",code:"JC-0012",hex:"#F7F6F2"},
        ],
        "틴트 Tint": [
            {name:"피치 블러쉬",code:"JC-1001",hex:"#F5D6C8"},
            {name:"살몬 핑크",code:"JC-1002",hex:"#F2B8A2"},
            {name:"로즈 쿼츠",code:"JC-1003",hex:"#F0CAC1"},
            {name:"페일 코랄",code:"JC-1004",hex:"#F4C4B0"},
            {name:"레몬 쉬폰",code:"JC-1005",hex:"#F8E8B0"},
            {name:"바닐라 크림",code:"JC-1006",hex:"#F5E6C4"},
            {name:"페일 옐로",code:"JC-1007",hex:"#F5E4A8"},
            {name:"라벤더 미스트",code:"JC-1008",hex:"#D8C8E0"},
            {name:"페일 라일락",code:"JC-1009",hex:"#E0D0E8"},
            {name:"베이비 블루",code:"JC-1010",hex:"#B8D4E8"},
            {name:"스카이 미스트",code:"JC-1011",hex:"#C4DCE8"},
            {name:"민트 프로스트",code:"JC-1012",hex:"#C0E0D4"},
            {name:"페일 세이지",code:"JC-1013",hex:"#D0DCC8"},
            {name:"피스타치오",code:"JC-1014",hex:"#D8E4C0"},
            {name:"셸 핑크",code:"JC-1015",hex:"#F0D8D0"},
            {name:"허니 듀",code:"JC-1016",hex:"#E8F0D0"},
        ],
        "톤 Tone": [
            {name:"더스티 로즈",code:"JC-2001",hex:"#C9A0A0"},
            {name:"올드 로즈",code:"JC-2002",hex:"#B88888"},
            {name:"말린 장미",code:"JC-2003",hex:"#C49090"},
            {name:"로즈우드",code:"JC-2004",hex:"#A07878"},
            {name:"테라코타",code:"JC-2005",hex:"#C08060"},
            {name:"시에나",code:"JC-2006",hex:"#B87848"},
            {name:"샌드스톤",code:"JC-2007",hex:"#C8B090"},
            {name:"카멜",code:"JC-2008",hex:"#C0A478"},
            {name:"올리브 그린",code:"JC-2009",hex:"#8C9468"},
            {name:"세이지",code:"JC-2010",hex:"#9CAC88"},
            {name:"유칼립투스",code:"JC-2011",hex:"#7CA088"},
            {name:"포레스트 미스트",code:"JC-2012",hex:"#6C9080"},
            {name:"더스티 블루",code:"JC-2013",hex:"#7C98B0"},
            {name:"스모키 블루",code:"JC-2014",hex:"#8898A8"},
            {name:"소프트 인디고",code:"JC-2015",hex:"#7880A0"},
            {name:"라벤더 그레이",code:"JC-2016",hex:"#9890A8"},
        ],
        "그레이 Gray": [
            {name:"웜 그레이 1",code:"JC-3001",hex:"#D8D4CC"},
            {name:"웜 그레이 3",code:"JC-3002",hex:"#C0BAB0"},
            {name:"웜 그레이 5",code:"JC-3003",hex:"#A8A098"},
            {name:"쿨 그레이 1",code:"JC-3004",hex:"#D0D0D4"},
            {name:"쿨 그레이 3",code:"JC-3005",hex:"#B4B4BC"},
            {name:"쿨 그레이 5",code:"JC-3006",hex:"#98989C"},
            {name:"스톤 그레이",code:"JC-3007",hex:"#9C9890"},
            {name:"차콜 라이트",code:"JC-3008",hex:"#787878"},
            {name:"그레이쥬",code:"JC-3009",hex:"#B8B0A8"},
            {name:"퓨터",code:"JC-3010",hex:"#8C8880"},
            {name:"실버 폭스",code:"JC-3011",hex:"#A8A4A0"},
            {name:"콘크리트",code:"JC-3012",hex:"#949088"},
        ],
        "컬러 Color": [
            {name:"코랄 레드",code:"JC-4001",hex:"#E05040"},
            {name:"버밀리온",code:"JC-4002",hex:"#D83020"},
            {name:"토마토 레드",code:"JC-4003",hex:"#E04030"},
            {name:"선셋 오렌지",code:"JC-4004",hex:"#E87830"},
            {name:"탠저린",code:"JC-4005",hex:"#F09028"},
            {name:"머스타드",code:"JC-4006",hex:"#D0A020"},
            {name:"선플라워",code:"JC-4007",hex:"#F0C020"},
            {name:"레몬 옐로",code:"JC-4008",hex:"#F0D830"},
            {name:"라임 그린",code:"JC-4009",hex:"#90C830"},
            {name:"에메랄드",code:"JC-4010",hex:"#28A870"},
            {name:"터쿼이즈",code:"JC-4011",hex:"#20A8A0"},
            {name:"스카이 블루",code:"JC-4012",hex:"#4098D8"},
            {name:"로얄 블루",code:"JC-4013",hex:"#2868C0"},
            {name:"울트라마린",code:"JC-4014",hex:"#3040B0"},
            {name:"바이올렛",code:"JC-4015",hex:"#7030A0"},
            {name:"매젠타",code:"JC-4016",hex:"#C02880"},
            {name:"핫 핑크",code:"JC-4017",hex:"#E03878"},
            {name:"클래식 레드",code:"JC-4018",hex:"#C82020"},
        ],
        "쉐이드 Shade": [
            {name:"버건디",code:"JC-5001",hex:"#701828"},
            {name:"와인",code:"JC-5002",hex:"#802030"},
            {name:"마호가니",code:"JC-5003",hex:"#6C3030"},
            {name:"초콜릿",code:"JC-5004",hex:"#5C3820"},
            {name:"다크 테라코타",code:"JC-5005",hex:"#904830"},
            {name:"번트 엄버",code:"JC-5006",hex:"#704020"},
            {name:"다크 올리브",code:"JC-5007",hex:"#4C5428"},
            {name:"헌터 그린",code:"JC-5008",hex:"#2C5838"},
            {name:"딥 티일",code:"JC-5009",hex:"#1C5860"},
            {name:"네이비",code:"JC-5010",hex:"#1C2848"},
            {name:"미드나잇 블루",code:"JC-5011",hex:"#182040"},
            {name:"딥 퍼플",code:"JC-5012",hex:"#381858"},
            {name:"포레스트",code:"JC-5013",hex:"#2C4830"},
            {name:"인디고",code:"JC-5014",hex:"#283068"},
        ],
        "블랙 Black": [
            {name:"소프트 블랙",code:"JC-6001",hex:"#303030"},
            {name:"차콜",code:"JC-6002",hex:"#383838"},
            {name:"앤트러사이트",code:"JC-6003",hex:"#2C2C30"},
            {name:"제트 블랙",code:"JC-6004",hex:"#1C1C1C"},
            {name:"오프 블랙",code:"JC-6005",hex:"#282424"},
            {name:"스모크",code:"JC-6006",hex:"#404040"},
        ],
    };

    /* ═══════════════════════════════════════
       State
       ═══════════════════════════════════════ */
    let running = false, raf = null;
    let fC = 0, fT = performance.now(), frameCount = 0;
    let seedX = -1, seedY = -1;
    let capCvs = null, capCtx = null;
    let matPool = null, poolW = 0, poolH = 0;
    let bfsQueue = null, bfsMask = null, bfsBufSize = 0;

    // 현재 선택 색상
    let currentColor = {hex:"#4488ff", r:68, g:136, b:255};
    let currentCategory = Object.keys(JEVISCO_COLORS)[0];

    /* ═══════════════════════════════════════
       FIXED PARAMETERS (사용자 지정 고정값)
       ═══════════════════════════════════════ */
    const FIXED = {
        bilateral: false,       // Bilateral 비활성
        texture: true,          // 텍스처 분산엣지 ON
        texBlock: 7,            // 블록 크기 7
        texThresh: 30,          // 분산 임계값 30
        multiScale: false,      // 멀티스케일 Canny OFF
        gray: true,             // Gray ON
        hue: false,             // Hue OFF
        sat: false,             // Saturation OFF
        blurK: 7,               // Gaussian kernel 7
        blurSigma: 0.6,         // sigma 0.6
        cannyLo: 26,            // threshold1 26
        cannyHi: 70,            // threshold2 70
        apertureSize: 3,        // apertureSize 3
        l2gradient: true,       // L2gradient (원본에서 ON)
        morphClose: true,       // MORPH_CLOSE ON
        closeK: 7,              // close kernel 7
        dilate: false,          // Dilate OFF
        dilateK: 3,
        scale: 1.0,             // 해상도 비율 1.0
        skip: false,            // 프레임 스킵 OFF
        maskDilate: 5,          // 마스크 팽창 5px
    };

    /* ═══════════════════════════════════════
       UI: 카테고리 탭 + 색상 칩 렌더링
       ═══════════════════════════════════════ */
    function renderCategoryTabs() {
        const tabs = document.getElementById('catTabs');
        tabs.innerHTML = '';
        Object.keys(JEVISCO_COLORS).forEach(cat => {
            const tab = document.createElement('div');
            tab.className = 'cat-tab' + (cat === currentCategory ? ' active' : '');
            tab.textContent = cat.split(' ')[0]; // 한글만
            tab.onclick = () => { currentCategory = cat; renderCategoryTabs(); renderColors(); };
            tabs.appendChild(tab);
        });
    }

    function renderColors() {
        const row = document.getElementById('colorRow');
        row.innerHTML = '';
        const colors = JEVISCO_COLORS[currentCategory] || [];
        colors.forEach(c => {
            const sw = document.createElement('div');
            sw.className = 'swatch' + (c.hex === currentColor.hex ? ' active' : '');
            sw.innerHTML = `
            <div class="chip" style="background:${c.hex}"></div>
            <span class="name">${c.name}</span>
            <span class="code">${c.code}</span>
        `;
            sw.onclick = () => selectColor(c);
            row.appendChild(sw);
        });
    }

    function selectColor(c) {
        currentColor.hex = c.hex;
        currentColor.r = parseInt(c.hex.slice(1,3),16);
        currentColor.g = parseInt(c.hex.slice(3,5),16);
        currentColor.b = parseInt(c.hex.slice(5,7),16);
        renderColors();
        // Update seed dot border
        const dot = document.getElementById('seedDot');
        dot.style.borderColor = c.hex;
    }

    // Init UI
    renderCategoryTabs();
    renderColors();

    /* ═══════════════════════════════════════
       Mat Pool
       ═══════════════════════════════════════ */
    function initPool(w, h) {
        if (matPool && poolW === w && poolH === h) return;
        destroyPool();
        poolW = w; poolH = h;
        matPool = {
            src: new cv.Mat(h, w, cv.CV_8UC4),
            gray: new cv.Mat(h, w, cv.CV_8UC1),
            blurredG: new cv.Mat(h, w, cv.CV_8UC1),
            edgeGray: new cv.Mat(h, w, cv.CV_8UC1),
            combined: new cv.Mat(h, w, cv.CV_8UC1),
            finalEdge: new cv.Mat(h, w, cv.CV_8UC1),
            // Texture
            texVariance: new cv.Mat(h, w, cv.CV_8UC1),
            texEdge: new cv.Mat(h, w, cv.CV_8UC1),
            meanMat: new cv.Mat(h, w, cv.CV_32FC1),
            sqMeanMat: new cv.Mat(h, w, cv.CV_32FC1),
            grayF: new cv.Mat(h, w, cv.CV_32FC1),
            graySq: new cv.Mat(h, w, cv.CV_32FC1),
            varMat: new cv.Mat(h, w, cv.CV_32FC1),
            // Mask dilate
            maskMat: new cv.Mat(h, w, cv.CV_8UC1),
            maskDilated: new cv.Mat(h, w, cv.CV_8UC1),
        };
    }

    function destroyPool() {
        if (!matPool) return;
        for (const k in matPool) {
            if (matPool[k] && matPool[k].delete) { try { matPool[k].delete(); } catch(_){} }
        }
        matPool = null; poolW = poolH = 0;
    }

    function ensureBFS(size) {
        if (bfsBufSize >= size) return;
        bfsQueue = new Int32Array(size);
        bfsMask = new Uint8Array(size);
        bfsBufSize = size;
    }

    /* ═══════════════════════════════════════
       BFS Flood Fill
       ═══════════════════════════════════════ */
    function bfsFloodFill(edgeArr, w, h, sx, sy) {
        const size = w * h;
        ensureBFS(size);
        const mask = bfsMask, queue = bfsQueue;
        mask.fill(0);
        if (sx<0||sy<0||sx>=w||sy>=h) return mask;
        const si = sy*w+sx;
        if (edgeArr[si]===255) return mask;
        let head=0, tail=0;
        queue[tail++]=si; mask[si]=255;
        while(head<tail){
            const idx=queue[head++], x=idx%w, y=(idx-x)/w;
            let n;
            if(x>0){n=idx-1;if(!mask[n]&&!edgeArr[n]){mask[n]=255;queue[tail++]=n;}}
            if(x<w-1){n=idx+1;if(!mask[n]&&!edgeArr[n]){mask[n]=255;queue[tail++]=n;}}
            if(y>0){n=idx-w;if(!mask[n]&&!edgeArr[n]){mask[n]=255;queue[tail++]=n;}}
            if(y<h-1){n=idx+w;if(!mask[n]&&!edgeArr[n]){mask[n]=255;queue[tail++]=n;}}
        }
        return mask;
    }

    /* ═══════════════════════════════════════
       Texture Variance Edge
       ═══════════════════════════════════════ */
    function computeTextureEdge(P, blockSize, threshold) {
        P.gray.convertTo(P.grayF, cv.CV_32FC1);
        cv.multiply(P.grayF, P.grayF, P.graySq);
        const ksize = new cv.Size(blockSize, blockSize);
        cv.blur(P.grayF, P.meanMat, ksize);
        cv.blur(P.graySq, P.sqMeanMat, ksize);
        cv.multiply(P.meanMat, P.meanMat, P.varMat);
        cv.subtract(P.sqMeanMat, P.varMat, P.varMat);
        P.varMat.convertTo(P.texVariance, cv.CV_8UC1, 1.0, 0);
        cv.Canny(P.texVariance, P.texEdge, threshold, threshold * 2, 3, false);
        return P.texEdge;
    }

    /* ═══════════════════════════════════════
       Click → seed
       ═══════════════════════════════════════ */
    document.getElementById('cvResult').addEventListener('click', function(e) {
        if (!running) return;
        const rect = this.getBoundingClientRect();
        seedX = Math.round((e.clientX - rect.left) * (this.width / rect.width));
        seedY = Math.round((e.clientY - rect.top) * (this.height / rect.height));
        const dot = document.getElementById('seedDot');
        dot.style.display = 'block';
        const pr = document.getElementById('cameraArea').getBoundingClientRect();
        dot.style.left = (e.clientX - pr.left) + 'px';
        dot.style.top = (e.clientY - pr.top) + 'px';
        dot.style.borderColor = currentColor.hex;
    });

    document.getElementById('cameraArea').addEventListener('click', function(e) {
        if (!running) { toggleCam(); }
    });

    function resetSeed() {
        seedX = seedY = -1;
        document.getElementById('seedDot').style.display = 'none';
        document.getElementById('fillInfo').textContent = '';
    }

    /* ═══════════════════════════════════════
       Camera
       ═══════════════════════════════════════ */
    async function toggleCam() {
        if (running) return stopCam();
        const video = document.getElementById('vid');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video:{facingMode:'environment',width:{ideal:640},height:{ideal:480}}
            });
            video.srcObject = stream;
            await video.play();
            await new Promise(r=>{const ck=()=>video.videoWidth>0?r():requestAnimationFrame(ck);ck();});
        } catch(e) { return alert('카메라 오류: '+e.message); }
        running = true; frameCount = 0;
        document.getElementById('ph').style.display = 'none';
        const b = document.getElementById('camBtn');
        b.classList.add('recording');
        capCvs = document.createElement('canvas');
        capCtx = capCvs.getContext('2d',{willReadFrequently:true});
        loop();
    }

    function stopCam() {
        running=false; seedX=seedY=-1;
        document.getElementById('seedDot').style.display='none';
        if(raf){cancelAnimationFrame(raf);raf=null;}
        const vd=document.getElementById('vid');
        if(vd.srcObject){vd.srcObject.getTracks().forEach(t=>t.stop());vd.srcObject=null;}
        document.getElementById('ph').style.display='';
        document.getElementById('camBtn').classList.remove('recording');
        destroyPool();
    }

    function captureFrame() {
        const c = document.getElementById('cvResult');
        if (!c.width || !c.height) return;
        const link = document.createElement('a');
        link.download = 'wall-paint-' + Date.now() + '.png';
        link.href = c.toDataURL('image/png');
        link.click();
    }

    /* ═══════════════════════════════════════
       Main Loop
       ═══════════════════════════════════════ */
    function loop() {
        if (!running) return;
        const video = document.getElementById('vid');
        const W = video.videoWidth, H = video.videoHeight;
        if (!W||!H) { raf=requestAnimationFrame(loop); return; }

        frameCount++;
        const F = FIXED;
        const PW = W, PH = H; // scale = 1.0

        for (const id of ['cvEdge','cvMask','cvResult']) {
            const c=document.getElementById(id);
            if(c.width!==W)c.width=W; if(c.height!==H)c.height=H;
        }
        capCvs.width=W; capCvs.height=H;
        initPool(PW, PH);

        const alpha = 0.7; // 고정값
        const fR = currentColor.r, fG = currentColor.g, fB = currentColor.b;

        capCtx.drawImage(video,0,0,W,H);
        const frameData = capCtx.getImageData(0,0,W,H);

        try {
            const P = matPool;
            P.src.data.set(frameData.data);

            // ══ GRAY → GaussianBlur → Canny ══
            cv.cvtColor(P.src, P.gray, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(P.gray, P.blurredG, new cv.Size(F.blurK, F.blurK), F.blurSigma);
            cv.Canny(P.blurredG, P.edgeGray, F.cannyLo, F.cannyHi, F.apertureSize, F.l2gradient);

            // combined = edgeGray (no sat, no hue)
            P.edgeGray.copyTo(P.finalEdge);

            // ══ TEXTURE VARIANCE EDGE ══
            if (F.texture) {
                computeTextureEdge(P, F.texBlock, F.texThresh);
                cv.bitwise_or(P.finalEdge, P.texEdge, P.finalEdge);
            }

            // ══ MORPH_CLOSE ══
            if (F.morphClose) {
                const kern = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(F.closeK, F.closeK));
                cv.morphologyEx(P.finalEdge, P.finalEdge, cv.MORPH_CLOSE, kern);
                kern.delete();
            }

            // ══ BFS + compositing ══
            const edgeArr = P.finalEdge.data;
            const resultCvs = document.getElementById('cvResult');
            const resultCtx = resultCvs.getContext('2d');
            resultCtx.putImageData(frameData, 0, 0);

            if (seedX>=0 && seedY>=0 && seedX<W && seedY<H) {
                let fillMask = bfsFloodFill(edgeArr, W, H, seedX, seedY);

                // 마스크 팽창
                if (F.maskDilate > 0) {
                    P.maskMat.data.set(fillMask);
                    const dk = F.maskDilate * 2 + 1;
                    const kern = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(dk, dk));
                    cv.dilate(P.maskMat, P.maskDilated, kern);
                    kern.delete();
                    fillMask = P.maskDilated.data;
                }

                const resultImg = resultCtx.getImageData(0,0,W,H);
                const rd = resultImg.data;
                const a1=1-alpha, aR=fR*alpha, aG=fG*alpha, aB=fB*alpha;
                let filledCount = 0;
                for(let i=0,len=W*H;i<len;i++){
                    if(fillMask[i]){
                        filledCount++;
                        const p=i*4;
                        rd[p]=rd[p]*a1+aR;
                        rd[p+1]=rd[p+1]*a1+aG;
                        rd[p+2]=rd[p+2]*a1+aB;
                    }
                }
                resultCtx.putImageData(resultImg,0,0);
                const pct=((filledCount/(W*H))*100).toFixed(1);
                document.getElementById('fillInfo').textContent=`${pct}% · ${filledCount.toLocaleString()}px`;
            } else {
                document.getElementById('fillInfo').textContent='';
            }
        } catch(e) {
            console.error('process error:', e);
        }

        fC++;
        const now=performance.now();
        if(now-fT>=1000){document.getElementById('fpsEl').textContent=Math.round(fC*1000/(now-fT))+' fps';fC=0;fT=now;}
        raf=requestAnimationFrame(loop);
    }

    /* ═══════════════════════════════════════
       Load OpenCV.js
       ═══════════════════════════════════════ */
    (function(){
        const s=document.createElement('script');
        s.src='https://docs.opencv.org/4.9.0/opencv.js';
        s.async=true;
        s.onload=()=>{
            const t=setInterval(()=>{
                try{if(typeof cv!=='undefined'&&cv.Mat){clearInterval(t);document.getElementById('ov').classList.add('gone');console.log('OpenCV.js ready ✓');}}catch(_){}
            },100);
            setTimeout(()=>{clearInterval(t);document.getElementById('ov').classList.add('gone');},20000);
        };
        document.head.appendChild(s);
    })();
</script>
</body>
</html>